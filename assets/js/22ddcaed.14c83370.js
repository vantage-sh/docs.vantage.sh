"use strict";(self.webpackChunkdocs_vantage_sh=self.webpackChunkdocs_vantage_sh||[]).push([[5577],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(n),h=r,m=c["".concat(l,".").concat(h)]||c[h]||d[h]||o;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},8582:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const o={id:"kubernetes_agent",title:"Vantage Kubernetes Agent",description:"This page walks through how to connect the Vantage Kubernetes agent with your Kubernetes cluster."},i="Vantage Kubernetes Agent",s={unversionedId:"kubernetes_agent",id:"kubernetes_agent",title:"Vantage Kubernetes Agent",description:"This page walks through how to connect the Vantage Kubernetes agent with your Kubernetes cluster.",source:"@site/docs/kubernetes_agent.md",sourceDirName:".",slug:"/kubernetes_agent",permalink:"/kubernetes_agent",draft:!1,editUrl:"https://github.com/vantage-sh/docs.vantage.sh/blob/master/docs/kubernetes_agent.md",tags:[],version:"current",frontMatter:{id:"kubernetes_agent",title:"Vantage Kubernetes Agent",description:"This page walks through how to connect the Vantage Kubernetes agent with your Kubernetes cluster."},sidebar:"someSidebar",previous:{title:"Kubernetes",permalink:"/connecting_kubernetes"},next:{title:"Kubernetes Costs",permalink:"/kubernetes"}},l={},p=[{value:"Agent Functionality",id:"agent-functionality",level:2},{value:"Service Compatibility",id:"service-compatibility",level:2},{value:"Google Kubernetes Engine (GKE) Autopilot",id:"gke-autopilot",level:3},{value:"Install Vantage Kubernetes Agent",id:"install-vantage-kubernetes-agent",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Create a Connection",id:"create-a-connection",level:2},{value:"Azure Kubernetes Service (AKS) Connections",id:"aks",level:3},{value:"Naming Your Clusters",id:"cluster-id",level:3},{value:"(Optional) Enable Collection of Annotations and Namespace Labels",id:"enable-annotations-namespace-labels",level:3},{value:"Manifest-Based Deployment Option",id:"manifest-deploy",level:3},{value:"Resource Usage",id:"resource-usage",level:3},{value:"Validate Installation",id:"validate-installation",level:3},{value:"Monitoring",id:"monitoring",level:3},{value:"Upgrade the Agent",id:"upgrade-agent",level:2},{value:"(Optional) Use S3 for Data Persistence",id:"data-persistence",level:2},{value:"Configure Agent for S3 Persistence",id:"configure-agent-for-s3-persistence",level:3},{value:"Common Errors",id:"common-errors",level:2},{value:"Failed to Fetch Presigned URL",id:"presigned-url-api",level:3},{value:"API Token Error",id:"api-token-error",level:4},{value:"404 Not Found Error",id:"404-not-found-error",level:4},{value:"Failed to Set Up Controller Store\u2014<code>MissingRegion</code>",id:"failed-to-set-up-controller-storemissingregion",level:3},{value:"DNS Lookup Error",id:"dns-lookup-error",level:3},{value:"EOF Error When Starting",id:"eof-error-when-starting",level:3},{value:"TLS Verify Error When Scraping Nodes",id:"tls-verify-error-when-scraping-nodes",level:3},{value:"Pod Scheduling Errors",id:"pod-scheduling-errors",level:3},{value:"Volume Support Error",id:"volume-support",level:3},{value:"Active Resources and Rightsizing Recommendations",id:"active-resources-and-rightsizing-recommendations",level:2},{value:"Migrate Costs from OpenCost to Vantage Kubernetes Agent",id:"migrate-costs-from-opencost-to-vantage-kubernetes-agent",level:2},{value:"Maintaining OpenCost Filters",id:"maintaining-opencost-filters",level:3}],u={toc:p},c="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"vantage-kubernetes-agent"},"Vantage Kubernetes Agent"),(0,r.kt)("p",null,"The Vantage Kubernetes agent is the default, recommended configuration to ingest cost and usage data from Kubernetes clusters to Vantage. The agent is a Docker container that runs in your Kubernetes cluster. The agent collects metrics and uploads them to Vantage."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"A primary provider (e.g., AWS, Azure, or GCP) is required to connect Kubernetes costs.")),(0,r.kt)("h2",{id:"agent-functionality"},"Agent Functionality"),(0,r.kt)("p",null,"The Vantage Kubernetes agent relies on native Kubernetes APIs, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"kube-apiserver")," for metadata and ",(0,r.kt)("inlineCode",{parentName:"p"},"kubelet")," for container data. Access to these APIs is controlled via Kubernetes RBAC using a Service Account and ClusterRole included in the Vantage Kubernetes agent ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/vantage-sh/helm-charts"},"Helm chart"),"."),(0,r.kt)("p",null,"Data is periodically collected and stored for aggregation, then sent directly to the Vantage service through an API, with your Vantage API token for authentication. This process avoids extra storage costs incurred by the OpenCost integration. The agent's architecture eliminates the need for deploying OpenCost-specific Prometheus pods, which makes scaling easier."),(0,r.kt)("div",{style:{display:"flex",justifyContent:"center",borderRadius:10,boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"}},(0,r.kt)("img",{alt:"Vantage Kubernetes agent architecture diagram",width:"60%",src:"https://assets.vantage.sh/blog/announcing-the-official-kubernetes-integration/vantage-kubernetes-agent-architecture.png",style:{borderRadius:10}})),(0,r.kt)("h2",{id:"service-compatibility"},"Service Compatibility"),(0,r.kt)("p",null,"The Vantage Kubernetes agent is compatible with the following services:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Amazon Elastic Kubernetes Service (EKS)"),(0,r.kt)("li",{parentName:"ul"},"Azure Kubernetes Service (AKS)"),(0,r.kt)("li",{parentName:"ul"},"Google Kubernetes Engine (GKE)")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"At this time, the agent does not support custom rates for on-premises servers. ")),(0,r.kt)("p",null,"As long as the cost data for an underlying cluster instance is ingested into Vantage via a cloud integration, it is possible to calculate the corresponding pod costs."),(0,r.kt)("h3",{id:"gke-autopilot"},"Google Kubernetes Engine (GKE) Autopilot"),(0,r.kt)("p",null,"For ",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview"},"GKE Autopilot")," users, you don\u2019t need to install the agent. These costs will already be present under ",(0,r.kt)("strong",{parentName:"p"},"Cost By Resource")," for the ",(0,r.kt)("strong",{parentName:"p"},"Kubernetes Engine")," service in a ",(0,r.kt)("a",{parentName:"p",href:"/cost_reports"},"Cost Report"),"."),(0,r.kt)("div",{style:{display:"flex",justifyContent:"center"}},(0,r.kt)("img",{alt:"GKE Autopilot filters on a Cost Report",width:"80%",src:"/img/gke-autopilot.png"})),(0,r.kt)("h2",{id:"install-vantage-kubernetes-agent"},"Install Vantage Kubernetes Agent"),(0,r.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("p",null,"The following prerequisites are required before you install the Vantage Kubernetes agent:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("a",{parentName:"p",href:"https://helm.sh/"},"Helm package manager")," for Kubernetes")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"kubectl"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"A running Kubernetes cluster")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"An already connected primary provider (i.e., ",(0,r.kt)("a",{parentName:"p",href:"/connecting_aws"},"AWS"),", ",(0,r.kt)("a",{parentName:"p",href:"/connecting_azure"},"Azure"),", or ",(0,r.kt)("a",{parentName:"p",href:"/connecting_gcp"},"GCP"),")")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"A ",(0,r.kt)("a",{parentName:"p",href:"/vantage_account#api-token"},"Vantage API token")," with READ and WRITE scopes enabled (it's recommended to use a ",(0,r.kt)("a",{parentName:"p",href:"/vantage_account#api-service-token"},"service token")," rather than a ",(0,r.kt)("a",{parentName:"p",href:"/vantage_account#api-personal-token"},"personal access token"),")")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"If you do not already have an integration enabled"),", navigate to the ",(0,r.kt)("a",{parentName:"p",href:"https://console.vantage.sh/settings/kubernetes?connect=true"},"Kubernetes Integration page")," in the Vantage console, and click the ",(0,r.kt)("strong",{parentName:"p"},"Enable Kubernetes Agent")," button (you won't need to do this for subsequent integrations)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Review the section on ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#data-persistence"},"Data Persistence")," before you begin")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Review the section on ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#cluster-id"},"Naming Your Clusters")))),(0,r.kt)("h2",{id:"create-a-connection"},"Create a Connection"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The following steps are also provided in the Vantage Kubernetes agent Helm chart repository. See ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/vantage-sh/helm-charts/tree/main/charts/vantage-kubernetes-agent"},"the Helm chart repository")," for all value configurations. If you would like to use a manifest-based option instead, see the ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#manifest-deploy"},"section below"))),(0,r.kt)("p",null,"To set up a ",(0,r.kt)("em",{parentName:"p"},"new")," Kubernetes agent connection:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the repository for the Vantage Kubernetes agent Helm chart."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add vantage https://vantage-sh.github.io/helm-charts\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install the ",(0,r.kt)("inlineCode",{parentName:"p"},"vantage-kubernetes-agent")," Helm chart. Ensure you update the values for ",(0,r.kt)("inlineCode",{parentName:"p"},"VANTAGE_API_TOKEN")," (obtained in the ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#prerequisites"},"Prerequisites")," above) and ",(0,r.kt)("inlineCode",{parentName:"p"},"CLUSTER_ID")," (the unique value for your cluster)."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm upgrade -n vantage vka vantage/vantage-kubernetes-agent --install --set agent.token=$VANTAGE_API_TOKEN,agent.clusterID=$CLUSTER_ID --create-namespace\n")))),(0,r.kt)("h3",{id:"aks"},"Azure Kubernetes Service (AKS) Connections"),(0,r.kt)("p",null,"If you are creating an AKS connection, you will need to configure the following parameters to avoid AKS-specific errors:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Set the ",(0,r.kt)("inlineCode",{parentName:"li"},"VANTAGE_KUBE_SKIP_TLS_VERIFY")," environment variable to ",(0,r.kt)("inlineCode",{parentName:"li"},"true"),". This setting is controlled by ",(0,r.kt)("inlineCode",{parentName:"li"},"agent.disableKubeTLSverify")," within the Helm chart. For details, see the ",(0,r.kt)("a",{parentName:"li",href:"/kubernetes_agent#tls-verify-error-when-scraping-nodes"},"TLS verify error")," section."),(0,r.kt)("li",{parentName:"ul"},"Configure the ",(0,r.kt)("inlineCode",{parentName:"li"},"VANTAGE_NODE_ADDRESS_TYPES")," environment variable, which is controlled by the ",(0,r.kt)("inlineCode",{parentName:"li"},"agent.nodeAddressTypes")," in the Helm chart. In this case, the type to use for your cluster will most likely be ",(0,r.kt)("inlineCode",{parentName:"li"},"InternalIP"),". For configuration details, see the ",(0,r.kt)("a",{parentName:"li",href:"/kubernetes_agent#dns-lookup-error"},"DNS lookup error")," section.")),(0,r.kt)("h3",{id:"cluster-id"},"Naming Your Clusters"),(0,r.kt)("p",null,"When you name your clusters, ensure the cluster ID adheres to Kubernetes object naming conventions. While the agent does not enforce specific formats, valid characters include:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Lowercase and uppercase letters (",(0,r.kt)("inlineCode",{parentName:"li"},"a-z"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"A-Z"),")"),(0,r.kt)("li",{parentName:"ul"},"Numbers (",(0,r.kt)("inlineCode",{parentName:"li"},"0-9"),")"),(0,r.kt)("li",{parentName:"ul"},"Periods (",(0,r.kt)("inlineCode",{parentName:"li"},"."),"), underscores (",(0,r.kt)("inlineCode",{parentName:"li"},"_"),"), and hyphens (",(0,r.kt)("inlineCode",{parentName:"li"},"-"),")")),(0,r.kt)("p",null,"In addition, when configuring the cluster ID, use a simplified, human-readable name that identifies the cluster. Avoid including full resource paths or unnecessary metadata. The cluster ID should be unique within your environment."),(0,r.kt)("h3",{id:"enable-annotations-namespace-labels"},"(Optional) Enable Collection of Annotations and Namespace Labels"),(0,r.kt)("p",null,"You can optionally enable the collection of annotations and namespace labels."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Annotations:")," The agent accepts a comma-separated list of annotation keys, called ",(0,r.kt)("inlineCode",{parentName:"li"},"VANTAGE_ALLOWED_ANNOTATIONS"),", as an environment variable at startup. To enable the collection of annotations, configure the ",(0,r.kt)("inlineCode",{parentName:"li"},"agent.allowedAnnotations")," ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/vantage-sh/helm-charts/blob/main/charts/vantage-kubernetes-agent/values.yaml#L31"},"parameter of the Helm chart")," with a list of annotations to be sent to Vantage. Note there is a max of 10 annotations, and values are truncated after 100 characters."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Namespace labels:")," The agent accepts ",(0,r.kt)("inlineCode",{parentName:"li"},"VANTAGE_COLLECT_NAMESPACE_LABELS")," as an environment variable at startup. To enable the collection of namespace labels, configure the ",(0,r.kt)("inlineCode",{parentName:"li"},"agent.collectNamespaceLabels")," ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/vantage-sh/helm-charts/blob/main/charts/vantage-kubernetes-agent/values.yaml#L34"},"parameter of the Helm chart"),".")),(0,r.kt)("h3",{id:"manifest-deploy"},"Manifest-Based Deployment Option"),(0,r.kt)("p",null,"You can use ",(0,r.kt)("inlineCode",{parentName:"p"},"helm template")," to generate a static manifest via the existing repo. This option generates files (YAML) so that you can then decide to deploy them however you want."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the repository for the Vantage Kubernetes agent Helm chart."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add vantage https://vantage-sh.github.io/helm-charts\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generate the static manifest."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm template -n vantage vka vantage/vantage-kubernetes-agent --set agent.token=$VANTAGE_API_TOKEN,agent.clusterID=$CLUSTER_ID\n")))),(0,r.kt)("h3",{id:"resource-usage"},"Resource Usage"),(0,r.kt)("p",null,"The limits provided within the Helm chart are set low to support small clusters (approximately 10 nodes) and should be considered the minimum values for deploying an agent."),(0,r.kt)("p",null,"Estimates for larger clusters are roughly:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"~1 CPU/1000 node"),(0,r.kt)("li",{parentName:"ul"},"~5 MB/node")),(0,r.kt)("p",null,"For example, a 100-node cluster would be approximately 500 MB and 100 mCPU. These amounts are estimates, which will vary based on pod density per node, label usage, cluster activity, etc. The agent should reach an approximate steady state after about one hour of uptime and can be tuned accordingly after the fact."),(0,r.kt)("p",null,"To set these options, extend the ",(0,r.kt)("inlineCode",{parentName:"p"},"--set")," flag. You can also include the values using one of the ",(0,r.kt)("a",{parentName:"p",href:"https://helm.sh/docs/chart_template_guide/values_files/"},"many options Helm supports"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"--set agent.token=$VANTAGE_API_TOKEN,agent.clusterID=$CLUSTER_ID,resources.limits.memory=100Mi,resources.requests.memory=100Mi\n")),(0,r.kt)("h3",{id:"validate-installation"},"Validate Installation"),(0,r.kt)("p",null,"Follow the steps below to validate the agent's installation."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Once installed, the agent's pod should become ",(0,r.kt)("inlineCode",{parentName:"li"},"READY"),":",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\u279c kubectl -n vantage get pod\nNAME                             READY   STATUS    RESTARTS   AGE\nvka-vantage-kubernetes-agent-0   1/1     Running   0          54m\n"))),(0,r.kt)("li",{parentName:"ol"},"Logs should be free of ",(0,r.kt)("inlineCode",{parentName:"li"},"ERROR")," messages:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\u279c kubectl -n vantage logs -f vka-vantage-kubernetes-agent-0\n{"time":"2023-10-23T22:01:12.065481528Z","level":"INFO","msg":"found nodes","nodes":231}\n...\n{"time":"2023-10-23T22:01:15.471399742Z","level":"INFO","msg":"finished initializing"}\n'))),(0,r.kt)("li",{parentName:"ol"},"Agent reporting should occur once per hour at the start of the hour and should not generate an ",(0,r.kt)("inlineCode",{parentName:"li"},"ERROR")," log line. It should also attempt a report soon after the initial start:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"time":"2023-10-23T22:01:00.015243974Z","level":"INFO","msg":"reporting now"}\n{"time":"2023-10-23T22:01:01.168390414Z","level":"INFO","msg":"finished reporting"}\n{"time":"2023-10-23T22:01:01.169876296Z","level":"INFO","msg":"next report window","start":"2023-10-23T22:00:00Z","end":"2023-10-23T23:00:00Z","sleeping_seconds":3598.830199804}\n')))),(0,r.kt)("p",null,"Costs are exported from the cluster hourly and then made available nightly. It's important to note that these costs might encounter delays based on their associated cloud integration's cost data. For instance, if there is a one-day delay in an AWS Cost and Usage Report, the clusters dependent on that data will experience a similar delay."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"You can view and manage your Kubernetes integration on the ",(0,r.kt)("a",{parentName:"p",href:"https://console.vantage.sh/settings/kubernetes"},"Kubernetes Integration page")," in the console. Hover over the integration in the list, and click ",(0,r.kt)("strong",{parentName:"p"},"Manage"),".")),(0,r.kt)("h3",{id:"monitoring"},"Monitoring"),(0,r.kt)("p",null,"The agent exposes a Prometheus metrics endpoint via the ",(0,r.kt)("inlineCode",{parentName:"p"},"/metrics")," endpoint, exposed by default on port ",(0,r.kt)("inlineCode",{parentName:"p"},"9010"),". This port can be changed via the Helm chart's ",(0,r.kt)("inlineCode",{parentName:"p"},"service.port")," value."),(0,r.kt)("p",null,"The metrics endpoint includes standard Golang process stats as well as agent-related metrics for node scrape results, node scrape duration, internal data persistence, and reporting."),(0,r.kt)("p",null,"For users who want to monitor the agent:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},'vantage_last_node_scrape_count{result="fail"}')," should be low (between 0 and 1% of total nodes). Some failures may occur as nodes come and go within the cluster, but consistent failures are not expected and should be investigated."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},'rate(vantage_report_count{result="fail"}[5m])')," should be 0. Reporting occurs within the first 5 minutes of every hour and will retry roughly once per minute. Each failure increments this counter. If the agent is unable to report within the first 10 minutes of an hour, some data may be lost from the previous window, as only the previous ~70 data points are retained.")),(0,r.kt)("h2",{id:"upgrade-agent"},"Upgrade the Agent"),(0,r.kt)("p",null,"To see which version of the Kubernetes agent you are running:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"From the top navigation, click ",(0,r.kt)("strong",{parentName:"li"},"Settings"),"."),(0,r.kt)("li",{parentName:"ol"},"On the side navigation, click ",(0,r.kt)("strong",{parentName:"li"},"Integrations"),"."),(0,r.kt)("li",{parentName:"ol"},"A list of all your provider integrations is displayed. Select the ",(0,r.kt)("strong",{parentName:"li"},"Kubernetes")," integration."),(0,r.kt)("li",{parentName:"ol"},"On the ",(0,r.kt)("strong",{parentName:"li"},"Manage")," tab, click the settings button (looks like a cog wheel) next to a specific integration."),(0,r.kt)("li",{parentName:"ol"},"Scroll down to the ",(0,r.kt)("strong",{parentName:"li"},"Clusters")," section. Each cluster that is integrated with the agent is listed along with the current agent version and indicates if the agent is out of date.")),(0,r.kt)("div",{style:{display:"flex",justifyContent:"center"}},(0,r.kt)("img",{alt:"The Settings Clusters section with two sample clusters displayed along with the most recent version",width:"80%",src:"/img/k8s-upgrade-agent.png"})),(0,r.kt)("p",null,"To upgrade the agent, use the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo update && helm upgrade -n vantage vka vantage/vantage-kubernetes-agent --reuse-values\n")),(0,r.kt)("p",null,"The version noted in the console for your agent is updated when cost data is imported nightly."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"AKS users should remember to follow the ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#aks"},"AKS-specific instructions")," again when updating.")),(0,r.kt)("h2",{id:"data-persistence"},"(Optional) Use S3 for Data Persistence"),(0,r.kt)("p",null,"The agent requires a persistent store for periodic backups of time-series data as well as checkpointing for periodic reporting. The default deployment option uses a Persistent Volume and works for clusters ranging from tens to thousands of nodes; however, if Persistent Volumes are not supported with your cluster, an alternative configuration, using S3, is available for agents deployed in AWS. If you require persistence to a different object store, you can contact ",(0,r.kt)("a",{parentName:"p",href:"mailto:support@vantage.sh"},"support@vantage.sh"),"."),(0,r.kt)("h3",{id:"configure-agent-for-s3-persistence"},"Configure Agent for S3 Persistence"),(0,r.kt)("p",null,"The agent uses ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html"},"IAM roles for service accounts")," to access the configured bucket. The default ",(0,r.kt)("inlineCode",{parentName:"p"},"vantage")," namespace and ",(0,r.kt)("inlineCode",{parentName:"p"},"vka-vantage-kubernetes-agent")," service account names may vary based on your configuration."),(0,r.kt)("p",null,"Below are the expected associated permissions for the IAM role:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": [\n        "s3:GetObject",\n        "s3:PutObject",\n        "s3:ListBucket",\n        "s3:AbortMultipartUpload",\n        "s3:ListMultipartUploadParts",\n        "s3:DeleteObject"\n      ],\n      "Resource": [\n        "arn:aws:s3:::example-bucket-name/*",\n        "arn:aws:s3:::example-bucket-name"\n      ]\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"Once the permissions are available, the agent can be configured to start with S3 persistence via the environment variable ",(0,r.kt)("inlineCode",{parentName:"p"},"VANTAGE_PERSIST_S3_BUCKET")," or, if using the Helm chart, via the ",(0,r.kt)("inlineCode",{parentName:"p"},"--set persist=null --set persistS3.bucket=example-bucket-name")," values."),(0,r.kt)("p",null,"The agent will write persisted data to the ",(0,r.kt)("inlineCode",{parentName:"p"},"$CLUSTER_ID/")," prefix within the bucket. Multiple agents can use the same bucket as long as they do not have overlapping ",(0,r.kt)("inlineCode",{parentName:"p"},"CLUSTER_ID")," values. An optional prefix can be prepended with ",(0,r.kt)("inlineCode",{parentName:"p"},"VANTAGE_PERSIST_S3_PREFIX")," resulting in ",(0,r.kt)("inlineCode",{parentName:"p"},"$VANTAGE_PERSIST_S3_PREFIX/$CLUSTER_ID/")," being the prefix used by the agent for all objects uploaded."),(0,r.kt)("h2",{id:"common-errors"},"Common Errors"),(0,r.kt)("h3",{id:"presigned-url-api"},"Failed to Fetch Presigned URL"),(0,r.kt)("p",null,"A ",(0,r.kt)("inlineCode",{parentName:"p"},"failed to fetch presigned urls")," error can occur for a few reasons, as described below."),(0,r.kt)("h4",{id:"api-token-error"},"API Token Error"),(0,r.kt)("p",null,"The below error occurs when the agent attempts to fetch presigned URLs but fails due to an invalid ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," header field value. The error log typically looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"time":"2023-12-01T00:00:00.000000000Z","level":"ERROR","msg":"failed to fetch presigned urls","err":"Get \\"https://api.vantage.sh/internal/integrations/kubernetes_agent/\u2026": net/http: invalid header field value for \\"Authorization\\""}\n')),(0,r.kt)("p",null,"This issue is typically caused by incorrect or missing API keys. Ensure the value for the ",(0,r.kt)("inlineCode",{parentName:"p"},"VANTAGE_API_TOKEN")," (obtained in the ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#prerequisites"},"Prerequisites")," above) is valid and properly formatted. If necessary, generate a new token and update the configuration."),(0,r.kt)("h4",{id:"404-not-found-error"},"404 Not Found Error"),(0,r.kt)("p",null,"The below error occurs when the agent attempts to fetch presigned URLs but fails due to the cluster ID potentially including invalid characters. The error log typically looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"time":"2023-12-01T00:00:00.000000000Z","level":"ERROR","msg":"failed to fetch presigned urls","err":"unexpected response from API: 404 Not Found"}  \n')),(0,r.kt)("p",null,"Review the section on ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#cluster-id"},"Naming Your Clusters")," for best practices on how to name your clusters. Then, review the cluster ID in your configuration to confirm it is correct and valid. Update the configuration as needed to use a properly formatted cluster ID."),(0,r.kt)("h3",{id:"failed-to-set-up-controller-storemissingregion"},"Failed to Set Up Controller Store\u2014",(0,r.kt)("inlineCode",{parentName:"h3"},"MissingRegion")),(0,r.kt)("p",null,"This error occurs when the agent cannot initialize the controller store due to missing or misconfigured AWS region settings. The error log will typically look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"failed to setup controller store  \nfailed to open backup: MissingRegion: could not find region configuration  \n")),(0,r.kt)("p",null,"This issue arises when the agent\u2019s Service Account is not properly configured with AWS IAM roles and permissions. In this case, the agent defaults to local configuration, which lacks the necessary region configuration. "),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Verify the Service Account configuration:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Check if the ",(0,r.kt)("inlineCode",{parentName:"li"},"eks.amazonaws.com/role-arn")," annotation is correctly added to the Service Account. Run the following command to inspect the configuration:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl -n vantage get serviceaccount vka-vantage-kubernetes-agent -o yaml\n"))),(0,r.kt)("li",{parentName:"ul"},"Ensure the Service Account matches the Helm Chart settings in the agent\u2019s ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/vantage-sh/helm-charts/blob/main/charts/vantage-kubernetes-agent/values.yaml#L102-L106"},"Helm Chart values file"),". This is a name that you can also set within the file. "))),(0,r.kt)("li",{parentName:"ol"},"Ensure the IAM role is correctly set up:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Review the ",(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html"},"AWS IAM Roles for Service Accounts documentation")," to confirm that the IAM role is configured with the necessary permissions and associated with the Service Account."))),(0,r.kt)("li",{parentName:"ol"},"Configure S3 persistence:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"See the ",(0,r.kt)("a",{parentName:"li",href:"/kubernetes_agent/#configure-agent-for-s3-persistence"},"Agent S3 persistence setup")," section for details. ",(0,r.kt)("admonition",{parentName:"li",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"One recommendation is to ensure that the S3 bucket used for persistence is in the same region as the Kubernetes cluster to minimize latency."))))),(0,r.kt)("li",{parentName:"ol"},"If necessary, recreate the pod:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If the Service Account appears correct and there\u2019s still an issue, delete the agent pod to force a fresh start with the correct configuration:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl -n vantage delete pod -l app.kubernetes.io/name=vantage-kubernetes-agent\n")))))),(0,r.kt)("h3",{id:"dns-lookup-error"},"DNS Lookup Error"),(0,r.kt)("p",null,"You may receive a DNS Lookup Error that indicates ",(0,r.kt)("inlineCode",{parentName:"p"},'"level":"ERROR","msg":"failed to scrape node"')," and ",(0,r.kt)("inlineCode",{parentName:"p"},"no such host"),"."),(0,r.kt)("p",null,"The agent uses the ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/node/node-status/#addresses"},"node status addresses")," to determine what hostname to look up for the node's stats, which are available via the ",(0,r.kt)("inlineCode",{parentName:"p"},"/metrics/resource")," endpoint. This can be configured with the ",(0,r.kt)("inlineCode",{parentName:"p"},"VANTAGE_NODE_ADDRESS_TYPES")," environment variable, which is controlled by the ",(0,r.kt)("inlineCode",{parentName:"p"},"agent.nodeAddressTypes")," in the Helm chart. By default, the priority order is ",(0,r.kt)("inlineCode",{parentName:"p"},"Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP"),"."),(0,r.kt)("p",null,"To understand which type to use for your cluster, you can look at the available addresses for one of your nodes. The ",(0,r.kt)("inlineCode",{parentName:"p"},"type")," corresponds to one of the configurable ",(0,r.kt)("inlineCode",{parentName:"p"},"nodeAddressTypes"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\u279c  kubectl get nodes -o=jsonpath=\'{.items[0].status.addresses}\'\n[{"address":"10.0.12.185","type":"InternalIP"},{"address":"ip-10-0-12-185.ec2.internal","type":"InternalDNS"},{"address":"ip-10-0-12-185.ec2.internal","type":"Hostname"}]\n')),(0,r.kt)("h3",{id:"eof-error-when-starting"},"EOF Error When Starting"),(0,r.kt)("p",null,"The agent uses local files for recovering from crashes or restarts. If this backup file becomes corrupted, most commonly due to ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#resource-usage"},"OOMKill"),", the most straightforward approach to get the agent running again is to perform a fresh install or remove the ",(0,r.kt)("inlineCode",{parentName:"p"},"PersistentVolumeClaim"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"PersistentVolume"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"Pod"),"."),(0,r.kt)("p",null,"An example error log line might look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"time":"2023-12-01T00:00:00.000000000Z","level":"ERROR","msg":"failed to setup data store","err":"unexpected EOF"}\n')),(0,r.kt)("p",null,"To uninstall the agent via ",(0,r.kt)("inlineCode",{parentName:"p"},"helm"),", run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm uninstall vka -n vantage\n")),(0,r.kt)("p",null,"Then, follow the original installation steps outlined in the above sections."),(0,r.kt)("h3",{id:"tls-verify-error-when-scraping-nodes"},"TLS Verify Error When Scraping Nodes"),(0,r.kt)("p",null,"The agent connects to each node to collect usage metrics from the ",(0,r.kt)("inlineCode",{parentName:"p"},"/metrics/resources")," endpoint. This access is managed via Kubernetes RBAC, but in some cases, the node's TLS certificate may not be valid and will result in TLS errors when attempting this connection. This most often affects clusters in AKS. To skip TLS verify within the Kubernetes client, you can set the ",(0,r.kt)("inlineCode",{parentName:"p"},"VANTAGE_KUBE_SKIP_TLS_VERIFY")," environment variable to ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),". This setting is controlled by ",(0,r.kt)("inlineCode",{parentName:"p"},"agent.disableKubeTLSverify")," within the Helm chart. This does not affect requests outside of the cluster itself, such as to the Vantage API or S3."),(0,r.kt)("p",null,"An example error log line might look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"time":"2024-02-10T12:00:00.000000000Z","level":"ERROR","msg":"failed to scrape node","err":"Get \\"https://10.100.20.20:10250/metrics/resource\\": tls: failed to verify certificate: x509: cannot validate certificate for 10.100.20.20 because it doesn\'t contain any IP SANs","node":"aks-nodepool9ids-1234567-vm0000001"}\n')),(0,r.kt)("p",null,"Once changed, you can validate the change by looking for the scraping summary log line and ensuring no more ",(0,r.kt)("inlineCode",{parentName:"p"},"ERROR")," level messages appear:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"time":"2024-02-10T12:00:00.000000000Z","level":"INFO","msg":"finished scraping metrics from nodes","success":25,"failure":0,"duration_ms":102}\n')),(0,r.kt)("h3",{id:"pod-scheduling-errors"},"Pod Scheduling Errors"),(0,r.kt)("p",null,"The most common cause for pod scheduling errors is the persistent volume not being provisioned. By default, the agent is deployed as a StatefulSet with a persistent volume for persisting internal state. The state allows the agent to recover from a restart without losing the historical data for the current reporting window. An example error for this case would be present in the events on the ",(0,r.kt)("inlineCode",{parentName:"p"},"vka-vantage-kubernetes-agent-0")," pod and include an error that contains ",(0,r.kt)("inlineCode",{parentName:"p"},"unbound immediate PersistentVolumeClaims"),"."),(0,r.kt)("p",null,"The resolution to this error is based on the cluster's configuration and the specific cloud provider. More information might be present on the persistent volume claim or persistent volume. For Kubernetes clusters on AWS, S3 can be used for ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#data-persistence"},"data persistence"),"."),(0,r.kt)("p",null,"Additional provider references are also listed here:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/gce-pd-csi-driver"},"GCP: Using the Compute Engine persistent disk CSI Driver")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/azure/aks/csi-storage-drivers"},"Azure: Container Storage Interface (CSI) drivers on Azure Kubernetes Service (AKS)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html"},"AWS: Amazon EBS CSI driver"))),(0,r.kt)("h3",{id:"volume-support"},"Volume Support Error"),(0,r.kt)("p",null,"If you see an error related to ",(0,r.kt)("inlineCode",{parentName:"p"},"binding volumes: context deadline exceeded"),", this means you may not have volume support on your cluster. This error typically occurs when your cluster is unable to provision or attach persistent storage volumes required by your applications. Check your cluster's configuration and ensure the storage provider is properly set up."),(0,r.kt)("h2",{id:"active-resources-and-rightsizing-recommendations"},"Active Resources and Rightsizing Recommendations"),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Rightsizing recommendations require version 1.0.24 or later of the Vantage Kubernetes agent. See the ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent#upgrade-agent"},"upgrading section")," for information on how to upgrade the agent. Once the upgrade is complete, the agent will begin uploading the data needed to generate rightsizing recommendations. After the agent is upgraded or installed, recommendations will become available within 48 hours. This step is required to ensure there is enough data to make a valid recommendation. Historical data is not available before the agent upgrade, so it is recommended that you observe cyclical resource usage patterns, such as a weekly spike when you first review recommendations.")),(0,r.kt)("p",null,"Vantage syncs Kubernetes managed workloads as ",(0,r.kt)("a",{parentName:"p",href:"/active_resources"},"active resources")," in your account. In cases where these workloads are identified to be overprovisioned, Vantage provides Kubernetes rightsizing recommendations. See the ",(0,r.kt)("a",{parentName:"p",href:"/cost_recommendations#kubernetes-rightsizing"},"Cost Recommendations")," documentation for details on how to view rightsizing recommendations for Kubernetes workloads."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"For a full guide on understanding rightsizing and how to rightsize Kubernetes workloads, see the following article in the ",(0,r.kt)("a",{parentName:"p",href:"https://handbook.vantage.sh/kubernetes/kubernetes-rightsizing"},"Cloud Cost Handbook"),".")),(0,r.kt)("h2",{id:"migrate-costs-from-opencost-to-vantage-kubernetes-agent"},"Migrate Costs from OpenCost to Vantage Kubernetes Agent"),(0,r.kt)("p",null,"If you are moving from an OpenCost integration to the agent-based integration, you can contact ",(0,r.kt)("a",{parentName:"p",href:"mailto:support@vantage.sh"},"support@vantage.sh")," to have your previous integration data maintained. Any overlapping data will be removed from the agent data by the Vantage team."),(0,r.kt)("h3",{id:"maintaining-opencost-filters"},"Maintaining OpenCost Filters"),(0,r.kt)("p",null,"If you previously used the OpenCost integration and are transitioning to the new agent-based integration, your existing filters will be retained. It's important to note that in situations where labels contained characters excluded from Prometheus labels, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"-"),", the OpenCost integration received the normalized versions of those labels from Prometheus. The Vantage Kubernetes agent, on the other hand, directly retrieves labels from the ",(0,r.kt)("inlineCode",{parentName:"p"},"kube-apiserver"),", resulting in more precise data. However, this change may necessitate updates to filters that previously relied on the normalized values. You can contact ",(0,r.kt)("a",{parentName:"p",href:"mailto:support@vantage.sh"},"support@vantage.sh")," to have these filters converted for you."))}d.isMDXComponent=!0}}]);