"use strict";(self.webpackChunkdocs_vantage_sh=self.webpackChunkdocs_vantage_sh||[]).push([[7051],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>k});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},g=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=c(a),g=o,k=u["".concat(s,".").concat(g)]||u[g]||m[g]||r;return a?n.createElement(k,l(l({ref:t},p),{},{components:a})):n.createElement(k,l({ref:t},p))}));function k(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,l=new Array(r);l[0]=g;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[u]="string"==typeof e?e:o,l[1]=i;for(var c=2;c<r;c++)l[c]=a[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}g.displayName="MDXCreateElement"},9449:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=a(7462),o=(a(7294),a(3905));const r={id:"connecting_snowflake",title:"Snowflake",description:"This page walks through how to integrate Vantage with your Snowflake account.",keywords:["Snowflake","Connect Snowflake"]},l="Snowflake",i={unversionedId:"connecting_snowflake",id:"connecting_snowflake",title:"Snowflake",description:"This page walks through how to integrate Vantage with your Snowflake account.",source:"@site/docs/connecting_snowflake.md",sourceDirName:".",slug:"/connecting_snowflake",permalink:"/connecting_snowflake",draft:!1,editUrl:"https://github.com/vantage-sh/docs.vantage.sh/blob/master/docs/connecting_snowflake.md",tags:[],version:"current",frontMatter:{id:"connecting_snowflake",title:"Snowflake",description:"This page walks through how to integrate Vantage with your Snowflake account.",keywords:["Snowflake","Connect Snowflake"]},sidebar:"someSidebar",previous:{title:"MongoDB Atlas",permalink:"/connecting_mongodb-atlas"},next:{title:"Snowflake Costs per Query",permalink:"/snowflake_cost_by_query"}},s={},c=[{value:"Connect Your Snowflake Account",id:"connect-your-snowflake-account",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Snowflake IP Allowed List",id:"snowflake-ip-allowed-list",level:3},{value:"Snowflake Schema for Vantage",id:"vantage-schema",level:3},{value:"Next Steps: Manage Workspace Access",id:"next-steps-manage-workspace-access",level:3},{value:"Data Refresh",id:"data-refresh",level:2},{value:"Troubleshoot Snowflake Errors",id:"troubleshoot-snowflake-errors",level:2},{value:"Snowflake Reporting Dimensions",id:"snowflake-reporting-dimensions",level:2},{value:"Active Resources",id:"active-resources",level:2}],p={toc:c},u="wrapper";function m(e){let{components:t,...a}=e;return(0,o.kt)(u,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"snowflake"},"Snowflake"),(0,o.kt)("p",null,"Vantage integrates with your Snowflake account through a secure, read-only user that has access to Snowflake usage tables. Optionally, you can create a ",(0,o.kt)("a",{parentName:"p",href:"/connecting_snowflake#vantage-schema"},"specific schema")," for the Vantage user."),(0,o.kt)("p",null,"Vantage requires read-only access to the following tables:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.snowflake.com/en/sql-reference/functions/warehouse_metering_history.html"},(0,o.kt)("inlineCode",{parentName:"a"},"SNOWFLAKE.ORGANIZATION_USAGE.WAREHOUSE_METERING_HISTORY")),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Returns hourly credit usage for both Virtual Warehouse credit usage and Cloud Services credit usage per warehouse, for all warehouses in your account. Data is retained for one year."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.snowflake.com/en/sql-reference/account-usage/query_history.html"},(0,o.kt)("inlineCode",{parentName:"a"},"SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY")),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Query history with various dimensions, including total elapsed time, warehouse used, data bytes scanned, etc. Data is retained for one year."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.snowflake.com/en/sql-reference/organization-usage/usage_in_currency_daily.html"},(0,o.kt)("inlineCode",{parentName:"a"},"SNOWFLAKE.ORGANIZATION_USAGE.USAGE_IN_CURRENCY_DAILY")),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Returns the daily credit usage and usage in currency format for an organization.")))),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"As a best practice, it is suggested you create a schema specifically for the ",(0,o.kt)("inlineCode",{parentName:"p"},"vantage")," user. Note, however, that this is optional. See the ",(0,o.kt)("a",{parentName:"p",href:"/connecting_snowflake#vantage-schema"},"steps below")," for details on how to create this schema.")),(0,o.kt)("h2",{id:"connect-your-snowflake-account"},"Connect Your Snowflake Account"),(0,o.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://console.vantage.sh/signup"},"Create a free Vantage account"),", then follow the steps below to integrate Snowflake costs."),(0,o.kt)("h3",{id:"snowflake-ip-allowed-list"},"Snowflake IP Allowed List"),(0,o.kt)("p",null,"If your Snowflake cluster uses an IP allow list for access control, you will need to add the following IPs to that allowed list:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"54.87.66.45\n3.95.43.133\n54.162.3.72\n44.199.143.63\n3.218.103.23\n")),(0,o.kt)("h3",{id:"vantage-schema"},"Snowflake Schema for Vantage"),(0,o.kt)("p",null,"After creating the below schema, you can add the required views to that schema and grant the ",(0,o.kt)("inlineCode",{parentName:"p"},"vantage")," user access to the schema."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"The below commands are based on the Snowflake ",(0,o.kt)("a",{parentName:"p",href:"https://community.snowflake.com/s/article/Solution-Grant-access-to-specific-views-in-SNOWFLAKE-ACCOUNT-USAGE-to-custom-roles"},"documentation"),".")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"From the top navigation in Vantage, click ",(0,o.kt)("strong",{parentName:"p"},"Settings"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"On the left navigation, select ",(0,o.kt)("strong",{parentName:"p"},"Integrations")," and select ",(0,o.kt)("strong",{parentName:"p"},"Snowflake"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The Snowflake integrations page is displayed. Ensure you are on the ",(0,o.kt)("strong",{parentName:"p"},"Connect")," tab.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Copy the code that's provided under ",(0,o.kt)("strong",{parentName:"p"},"Create Vantage User and Role")," to Snowflake. This SQL creates a user named ",(0,o.kt)("inlineCode",{parentName:"p"},"vantage"),", a role named ",(0,o.kt)("inlineCode",{parentName:"p"},"vantage"),", and a warehouse named ",(0,o.kt)("inlineCode",{parentName:"p"},"vantage"),". It also grants the necessary permissions. "),(0,o.kt)("admonition",{parentName:"li",type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Vantage automatically generates an ",(0,o.kt)("a",{parentName:"p",href:"https://docs.snowflake.com/en/user-guide/key-pair-auth"},"RSA public key")," for you to use when creating the Vantage user and role. You need to copy the code directly from the Vantage integration page to add the RSA key. ")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Sample of code. Copy directly from Vantage console to get RSA key."',title:'"Sample',of:!0,"code.":!0,Copy:!0,directly:!0,from:!0,Vantage:!0,console:!0,to:!0,get:!0,RSA:!0,'key."':!0},"USE role accountadmin;\nCREATE DATABASE vantage;\nCREATE ROLE vantage;\nCREATE USER vantage;\nGRANT ROLE vantage to user vantage;\nGRANT ROLE vantage to role accountadmin;\nCREATE WAREHOUSE vantage;\nGRANT ALL ON WAREHOUSE vantage TO ROLE vantage;\nALTER USER vantage SET DEFAULT_WAREHOUSE=vantage, DEFAULT_ROLE=vantage;\nALTER USER vantage SET password='';\nALTER USER vantage SET RSA_PUBLIC_KEY='<YOUR_RSA_KEY_GENERATED_BY_VANTAGE>';\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Copy the next code block to set up the Vantage-specific schema to read billing and usage data from your account."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"USE WAREHOUSE vantage;\nCREATE VIEW VANTAGE.PUBLIC.QUERY_HISTORY as select * from SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY;\nCREATE VIEW VANTAGE.PUBLIC.WAREHOUSE_METERING_HISTORY as select * from SNOWFLAKE.ORGANIZATION_USAGE.WAREHOUSE_METERING_HISTORY;\nCREATE VIEW VANTAGE.PUBLIC.USAGE_IN_CURRENCY_DAILY as select * from SNOWFLAKE.ORGANIZATION_USAGE.USAGE_IN_CURRENCY_DAILY;\nGRANT USAGE ON SCHEMA vantage.public TO ROLE vantage;\nGRANT USAGE ON DATABASE vantage TO ROLE vantage;\nGRANT SELECT ON ALL VIEWS IN SCHEMA vantage.public TO ROLE vantage;\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Test your setup in Snowflake."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"USE role vantage;\nSELECT * FROM vantage.public.query_history LIMIT 1;\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"At the bottom of the Vantage console Snowflake integration page, click ",(0,o.kt)("strong",{parentName:"p"},"Add Connection"),". ")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Add the following information to the form:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Server URL"),": In the format ",(0,o.kt)("inlineCode",{parentName:"li"},"<account_identifier>.<region>.snowflakecomputing.com"),". "),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Database"),": The name of the database the usage views are in (e.g., ",(0,o.kt)("inlineCode",{parentName:"li"},"vantage"),")."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Schema"),": The name of the schema the usage views are in (e.g., ",(0,o.kt)("inlineCode",{parentName:"li"},"public"),")."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Username")," set for the ",(0,o.kt)("inlineCode",{parentName:"li"},"vantage")," user. "))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Click ",(0,o.kt)("strong",{parentName:"p"},"Connect Account"),". "))),(0,o.kt)("p",null,"Costs will be ingested and processed as soon as you add the integration, but it may take several hours to populate within Vantage depending on the query volume of your warehouse. As soon as they are processed, they will be available on your All Resources Cost Report. If you decide to remove your Snowflake integration from Vantage, all costs associated with your Snowflake integration will be removed from the Vantage console. "),(0,o.kt)("h3",{id:"next-steps-manage-workspace-access"},"Next Steps: Manage Workspace Access"),(0,o.kt)("p",null,"Once your costs are imported, select which workspaces this integration is associated with. See the ",(0,o.kt)("a",{parentName:"p",href:"/workspaces#integration-workspace"},"Workspaces")," documentation for information."),(0,o.kt)("h2",{id:"data-refresh"},"Data Refresh"),(0,o.kt)("p",null,"See the ",(0,o.kt)("a",{parentName:"p",href:"/provider_data_refresh"},"provider data refresh documentation")," for information on when data for each provider refreshes in Vantage."),(0,o.kt)("h2",{id:"troubleshoot-snowflake-errors"},"Troubleshoot Snowflake Errors"),(0,o.kt)("p",null,"Snowflake occasionally makes changes to the queries/tables that get used for cost and usage attribution, causing the views in Vantage to then be based on an old query. You may see an error in the Vantage console, similar to the below error:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"View definition for 'VANTAGE.PUBLIC.QUERY_HISTORY' declared 66 column(s), but view query produces 77 column(s).\n")),(0,o.kt)("p",null,"To fix the issue, replace the three ",(0,o.kt)("inlineCode",{parentName:"p"},"Vantage")," views in Snowflake and ensure the ",(0,o.kt)("inlineCode",{parentName:"p"},"vantage")," user is granted permission on those views. "),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"After you've completed the below steps, contact ",(0,o.kt)("a",{parentName:"p",href:"mailto:support@vantage.sh"},"support@vantage.sh")," to reimport your Snowflake data.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"USE WAREHOUSE vantage;\nCREATE OR REPLACE VIEW VANTAGE.PUBLIC.QUERY_HISTORY as select * from SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY;\nCREATE OR REPLACE VIEW VANTAGE.PUBLIC.WAREHOUSE_METERING_HISTORY as select * from SNOWFLAKE.ORGANIZATION_USAGE.WAREHOUSE_METERING_HISTORY;\nCREATE OR REPLACE VIEW VANTAGE.PUBLIC.USAGE_IN_CURRENCY_DAILY as select * from SNOWFLAKE.ORGANIZATION_USAGE.USAGE_IN_CURRENCY_DAILY;\nGRANT USAGE ON SCHEMA vantage.public TO ROLE vantage;\nGRANT USAGE ON DATABASE vantage TO ROLE vantage;\nGRANT SELECT ON ALL VIEWS IN SCHEMA vantage.public TO ROLE vantage;\n")),(0,o.kt)("h2",{id:"snowflake-reporting-dimensions"},"Snowflake Reporting Dimensions"),(0,o.kt)("p",null,"On Snowflake ",(0,o.kt)("a",{parentName:"p",href:"/cost_reports"},"Cost Reports"),", you can filter across several dimensions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Account (account name)"),(0,o.kt)("li",{parentName:"ul"},"Category (e.g., Data Cloud Data Transfer)"),(0,o.kt)("li",{parentName:"ul"},"Metadata (e.g., ",(0,o.kt)("inlineCode",{parentName:"li"},"environment is staging"),")"),(0,o.kt)("li",{parentName:"ul"},"Region (e.g., AWS Eu West 1)"),(0,o.kt)("li",{parentName:"ul"},"Organization (organization name)"),(0,o.kt)("li",{parentName:"ul"},"Service (e.g., Data Cloud)"),(0,o.kt)("li",{parentName:"ul"},"Tag (",(0,o.kt)("a",{parentName:"li",href:"/tagging"},"virtual tags")," created in Vantage for this provider)"),(0,o.kt)("li",{parentName:"ul"},"Charge Type (e.g., Usage)")),(0,o.kt)("h2",{id:"active-resources"},"Active Resources"),(0,o.kt)("p",null,"Snowflake queries are synced as active resources and available in ",(0,o.kt)("a",{parentName:"p",href:"/active_resources"},"resource reports"),"."))}m.isMDXComponent=!0}}]);